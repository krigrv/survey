<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Survey Builder</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/auth.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
</head>
<body class="auth-body">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="auth-container">
        <div class="auth-card setup-card">
            <!-- Header -->
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-cogs"></i>
                </div>
                <h1 class="auth-title">Welcome to Survey Builder</h1>
                <p class="auth-subtitle">Let's set up your super admin account</p>
            </div>

            <!-- Setup Steps -->
            <div class="setup-steps mb-4">
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Admin Account</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">System Settings</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Complete</div>
                    </div>
                </div>
            </div>

            <!-- Setup Form -->
            <div class="auth-body">
                <!-- Step 1: Admin Account -->
                <div class="setup-step" id="step1">
                    <h3 class="mb-3">
                        <i class="fas fa-user-shield"></i> Create Super Admin Account
                    </h3>
                    <p class="text-muted mb-4">
                        This account will have full access to manage the system, users, and applications.
                    </p>
                    
                    <form id="adminAccountForm" class="auth-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">
                                    <i class="fas fa-user"></i> First Name
                                </label>
                                <input type="text" class="form-control" id="firstName" name="firstName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">
                                    <i class="fas fa-user"></i> Last Name
                                </label>
                                <input type="text" class="form-control" id="lastName" name="lastName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope"></i> Email Address
                            </label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock"></i> Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength mt-2">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Enter a password</small>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">
                                <i class="fas fa-lock"></i> Confirm Password
                            </label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <button type="button" class="btn btn-primary w-100" id="nextStep1">
                            Next: System Settings <i class="fas fa-arrow-right"></i>
                        </button>
                    </form>
                </div>

                <!-- Step 2: System Settings -->
                <div class="setup-step" id="step2" style="display: none;">
                    <h3 class="mb-3">
                        <i class="fas fa-cog"></i> System Configuration
                    </h3>
                    <p class="text-muted mb-4">
                        Configure basic system settings for your Survey Builder instance.
                    </p>
                    
                    <form id="systemSettingsForm" class="auth-form">
                        <div class="mb-3">
                            <label for="organizationName" class="form-label">
                                <i class="fas fa-building"></i> Organization Name
                            </label>
                            <input type="text" class="form-control" id="organizationName" name="organizationName" required>
                            <div class="form-text">This will appear in the application header and emails.</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="systemEmail" class="form-label">
                                <i class="fas fa-envelope"></i> System Email
                            </label>
                            <input type="email" class="form-control" id="systemEmail" name="systemEmail" required>
                            <div class="form-text">Email address used for system notifications.</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timezone" class="form-label">
                                <i class="fas fa-clock"></i> Default Timezone
                            </label>
                            <select class="form-select" id="timezone" name="timezone" required>
                                <option value="">Select timezone...</option>
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="Europe/London">London (GMT)</option>
                                <option value="Europe/Paris">Paris (CET)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Asia/Shanghai">Shanghai (CST)</option>
                                <option value="Asia/Kolkata">India (IST)</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowRegistration" name="allowRegistration">
                                <label class="form-check-label" for="allowRegistration">
                                    Allow user self-registration
                                </label>
                                <div class="form-text">If enabled, users can create accounts without admin approval.</div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" id="prevStep2">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary flex-fill" id="nextStep2">
                                Complete Setup <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Step 3: Complete -->
                <div class="setup-step" id="step3" style="display: none;">
                    <div class="text-center">
                        <div class="setup-success-icon mb-3">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <h3 class="mb-3">Setup Complete!</h3>
                        <p class="text-muted mb-4">
                            Your Survey Builder instance has been successfully configured. You can now start creating forms and managing users.
                        </p>
                        
                        <div class="setup-summary mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Setup Summary</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success"></i> Super admin account created</li>
                                        <li><i class="fas fa-check text-success"></i> System settings configured</li>
                                        <li><i class="fas fa-check text-success"></i> Database initialized</li>
                                        <li><i class="fas fa-check text-success"></i> Ready to use</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-lg" id="goToDashboard">
                            <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                        </button>
                    </div>
                </div>
                
                <!-- Error/Success Messages -->
                <div id="setupMessage" class="auth-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    
    <script>
        // Setup page specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            const totalSteps = 3;
            
            // Check if setup is already completed
            window.api.get('/auth/setup-status')
                .then(response => {
                    if (response.isSetupComplete) {
                        window.location.href = '/login.html';
                    }
                })
                .catch(() => {
                    // Setup not complete, continue with setup
                });
            
            // Password visibility toggle
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
            
            // Password strength checker
            document.getElementById('password').addEventListener('input', function() {
                const password = this.value;
                const strength = window.auth.calculatePasswordStrength(password);
                const indicator = document.getElementById('passwordStrengthText');
                window.auth.updatePasswordStrength(indicator, strength);
            });
            
            // Step navigation
            function updateStepIndicator(step) {
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    stepEl.classList.toggle('active', index + 1 <= step);
                    stepEl.classList.toggle('completed', index + 1 < step);
                });
            }
            
            function showStep(step) {
                document.querySelectorAll('.setup-step').forEach(stepEl => {
                    stepEl.style.display = 'none';
                });
                document.getElementById(`step${step}`).style.display = 'block';
                updateStepIndicator(step);
                currentStep = step;
            }
            
            // Step 1: Admin Account
            document.getElementById('nextStep1').addEventListener('click', function() {
                const form = document.getElementById('adminAccountForm');
                
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (password !== confirmPassword) {
                    window.utils.showFieldError(form, 'confirmPassword', 'Passwords do not match');
                    return;
                }
                
                const strength = window.auth.calculatePasswordStrength(password);
                if (strength.score < 3) {
                    window.utils.showFieldError(form, 'password', 'Password is too weak. Please choose a stronger password.');
                    return;
                }
                
                showStep(2);
            });
            
            // Step 2: System Settings
            document.getElementById('prevStep2').addEventListener('click', function() {
                showStep(1);
            });
            
            document.getElementById('nextStep2').addEventListener('click', async function() {
                const systemForm = document.getElementById('systemSettingsForm');
                const adminForm = document.getElementById('adminAccountForm');
                
                if (!systemForm.checkValidity()) {
                    systemForm.classList.add('was-validated');
                    return;
                }
                
                try {
                    const adminData = window.utils.serializeForm(adminForm);
                    const systemData = window.utils.serializeForm(systemForm);
                    
                    const setupData = {
                        admin: adminData,
                        system: systemData
                    };
                    
                    await window.api.post('/auth/setup', setupData);
                    
                    showStep(3);
                } catch (error) {
                    window.utils.toast.error(error.message || 'Setup failed. Please try again.');
                }
            });
            
            // Complete setup
            document.getElementById('goToDashboard').addEventListener('click', function() {
                window.location.href = '/login.html';
            });
            
            // Auto-detect timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timezoneSelect = document.getElementById('timezone');
            if (timezoneSelect.querySelector(`option[value="${timezone}"]`)) {
                timezoneSelect.value = timezone;
            }
            
            // Auto-focus first field
            document.getElementById('firstName').focus();
        });
    </script>
</body>
</html>